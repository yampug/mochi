name: CI Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  checks: write       # Required for test reporting
  pull-requests: write  # Required for PR comments

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Crystal
        uses: crystal-lang/install-crystal@v1
        with:
          crystal: latest

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true
          working-directory: devground/components

      - name: Install Crystal dependencies
        run: cd compiler && shards install

      - name: Generate batteries (required files)
        run: |
          ruby scripts/fragments_generator.rb
          crystal tool format ./compiler/src/generated

      - name: Run Crystal tests with JUnit output
        run: |
          cd compiler
          mkdir -p test-results
          crystal spec -v --fail-fast --link-flags="-L$GITHUB_WORKSPACE/fragments/libs" -- --junit_output test-results
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/fragments/libs
        continue-on-error: true  # Allow test report step to run even if tests fail

      - name: Install Playwright dependencies
        run: cd e2e && npm ci

      - name: Install Playwright browsers
        run: cd e2e && npx playwright install --with-deps chromium

      - name: Install swc for minification
        run: npm install -g @swc/cli @swc/core

      - name: Compile Mochi for E2E tests
        run: cd compiler && crystal run src/mochi.cr --link-flags="-L$GITHUB_WORKSPACE/fragments/libs" -- -i "../devground/components" -o "../devground/public" --minimize --typecheck
        env:
          MO_INT_LOGS: false
          MO_INT_LOGS_LEVEL: INFO
          LD_LIBRARY_PATH: ${{ github.workspace }}/fragments/libs

      - name: Run Playwright tests
        run: cd e2e && npx playwright test
        continue-on-error: true  # Allow test report step to run even if tests fail

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            compiler/test-results/*.xml
            e2e/test-results/*.xml

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: e2e/playwright-report/

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: always()  # Run even if tests fail
        with:
          report_paths: |
            compiler/test-results/*.xml
            e2e/test-results/*.xml
          check_name: Test Results (Crystal + Playwright)
          detailed_summary: true
          include_passed: true
          fail_on_failure: true
